# ç®¡ç†å‘˜è®¤è¯æœåŠ¡ä½¿ç”¨è¯´æ˜

## ğŸ¯ æ¦‚è¿°

æˆ‘å·²ç»æˆåŠŸå°† `GET /api/admin/auth` çš„è®¤è¯é€»è¾‘æŠ½è±¡ä¸ºé€šç”¨çš„ `AdminAuthService` ç±»å’Œä¾¿æ·å‡½æ•°ï¼Œç°åœ¨å¯ä»¥åœ¨æ•´ä¸ªåº”ç”¨ä¸­å¤ç”¨è¿™äº›è®¤è¯æ–¹æ³•ã€‚

## ğŸ“ æ ¸å¿ƒæ–‡ä»¶

### `src/lib/server/auth.ts`
åŒ…å«å®Œæ•´çš„ç®¡ç†å‘˜è®¤è¯æœåŠ¡ç±»å’Œä¾¿æ·å‡½æ•°ã€‚

## ğŸ”§ ä¸»è¦åŠŸèƒ½

### 1. AdminAuthService ç±»

#### é™æ€æ–¹æ³•åˆ—è¡¨ï¼š

- **`validateCredentials(credentials)`** - éªŒè¯ç™»å½•å‡­æ®
- **`createSession(username)`** - åˆ›å»ºä¼šè¯å¯¹è±¡
- **`setSessionCookie(cookies, session)`** - è®¾ç½®ä¼šè¯ Cookie
- **`getSession(cookies)`** - è·å–å½“å‰ä¼šè¯
- **`isAuthenticated(cookies)`** - æ£€æŸ¥æ˜¯å¦å·²è®¤è¯
- **`getAuthenticatedUsername(cookies)`** - è·å–å½“å‰ç”¨æˆ·å
- **`clearSession(cookies)`** - æ¸…é™¤ä¼šè¯
- **`verifyApiAccess(cookies)`** - éªŒè¯ API è®¿é—®æƒé™
- **`refreshSession(cookies)`** - åˆ·æ–°ä¼šè¯è¿‡æœŸæ—¶é—´
- **`getSessionStatus(cookies)`** - è·å–è¯¦ç»†ä¼šè¯çŠ¶æ€

### 2. ä¾¿æ·å‡½æ•°

- **`checkAdminAuth(cookies)`** - æ£€æŸ¥ç®¡ç†å‘˜ç™»å½•çŠ¶æ€
- **`requireAdminAuth(cookies)`** - è¦æ±‚ç®¡ç†å‘˜æƒé™ï¼ˆæŠ›å‡ºå¼‚å¸¸ï¼‰
- **`verifyAdminApiAccess(cookies)`** - éªŒè¯ API è®¿é—®æƒé™
- **`requireAdminPage(cookies, redirectTo)`** - é¡µé¢çº§è®¤è¯ä¸­é—´ä»¶
- **`checkAdminPage(cookies)`** - å¯é€‰çš„ç®¡ç†å‘˜åŠŸèƒ½æ£€æŸ¥

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### 1. API ç«¯ç‚¹ä¸­ä½¿ç”¨

#### éªŒè¯ API è®¿é—®æƒé™
```typescript
// src/routes/api/admin/sites/+server.ts
import { verifyAdminApiAccess } from '$lib/server/auth.js';

export const GET: RequestHandler = async ({ cookies }) => {
  // éªŒè¯ç®¡ç†å‘˜æƒé™
  const authResult = verifyAdminApiAccess(cookies);
  
  if (!authResult.isAuthorized) {
    return json({
      success: false,
      error: 'UNAUTHORIZED',
      message: authResult.error || 'éœ€è¦ç®¡ç†å‘˜æƒé™'
    }, { status: 401 });
  }

  // ç»§ç»­å¤„ç†å·²è®¤è¯çš„è¯·æ±‚
  // ...
};
```

#### ä½¿ç”¨ AdminAuthService ç±»
```typescript
import { AdminAuthService } from '$lib/server/auth.js';

export const POST: RequestHandler = async ({ request, cookies }) => {
  // éªŒè¯å‡­æ®
  const credentials = await request.json();
  const validation = AdminAuthService.validateCredentials(credentials);
  
  if (!validation.isValid) {
    return json({ error: validation.error }, { status: 401 });
  }

  // åˆ›å»ºä¼šè¯
  const session = AdminAuthService.createSession(credentials.username);
  AdminAuthService.setSessionCookie(cookies, session);
  
  return json({ success: true });
};
```

### 2. é¡µé¢æœåŠ¡ç«¯ä½¿ç”¨

#### è¦æ±‚ç®¡ç†å‘˜æƒé™çš„é¡µé¢
```typescript
// src/routes/admin/dashboard/+page.server.ts
import { requireAdminPage } from '$lib/server/auth.js';

export const load: PageServerLoad = async ({ cookies }) => {
  // è¦æ±‚ç®¡ç†å‘˜æƒé™ï¼Œæœªè®¤è¯ä¼šè‡ªåŠ¨é‡å®šå‘åˆ° /admin
  const adminSession = requireAdminPage(cookies);
  
  return {
    admin: {
      username: adminSession.username,
      loginTime: new Date()
    }
  };
};
```

#### å¯é€‰ç®¡ç†å‘˜åŠŸèƒ½çš„é¡µé¢
```typescript
// src/routes/+page.server.ts
import { checkAdminPage } from '$lib/server/auth.js';

export const load: PageServerLoad = async ({ cookies }) => {
  // æ£€æŸ¥ç®¡ç†å‘˜æƒé™ä½†ä¸å¼ºåˆ¶é‡å®šå‘
  const { isAdmin, session } = checkAdminPage(cookies);
  
  return {
    isAdmin,
    adminUsername: session?.username
  };
};
```

### 3. æ£€æŸ¥è®¤è¯çŠ¶æ€

#### ç®€å•æ£€æŸ¥
```typescript
import { AdminAuthService } from '$lib/server/auth.js';

// æ£€æŸ¥æ˜¯å¦å·²è®¤è¯
const isAuth = AdminAuthService.isAuthenticated(cookies);

// è·å–ç”¨æˆ·å
const username = AdminAuthService.getAuthenticatedUsername(cookies);
```

#### è¯¦ç»†çŠ¶æ€æ£€æŸ¥
```typescript
import { AdminAuthService } from '$lib/server/auth.js';

const status = AdminAuthService.getSessionStatus(cookies);
console.log({
  isAuthenticated: status.isAuthenticated,
  username: status.username,
  expiresAt: status.expiresAt,
  timeRemaining: status.timeRemaining // æ¯«ç§’
});
```

### 4. ä¼šè¯ç®¡ç†

#### åˆ·æ–°ä¼šè¯
```typescript
import { AdminAuthService } from '$lib/server/auth.js';

// åˆ·æ–°ä¼šè¯è¿‡æœŸæ—¶é—´
const refreshed = AdminAuthService.refreshSession(cookies);
if (refreshed) {
  console.log('ä¼šè¯å·²åˆ·æ–°');
}
```

#### æ¸…é™¤ä¼šè¯
```typescript
import { AdminAuthService } from '$lib/server/auth.js';

// ç™»å‡ºæ—¶æ¸…é™¤ä¼šè¯
AdminAuthService.clearSession(cookies);
```

## ğŸ“Š å·²æ›´æ–°çš„æ–‡ä»¶

### 1. API ç«¯ç‚¹
- **`src/routes/api/admin/auth/+server.ts`** - ä½¿ç”¨æ–°çš„è®¤è¯æœåŠ¡é‡æ„
- **`src/routes/api/admin/sites/+server.ts`** - ç¤ºä¾‹ç®¡ç†å‘˜ APIï¼ˆæ–°å»ºï¼‰

## ğŸ” å®‰å…¨ç‰¹æ€§

### 1. ä¼šè¯ç®¡ç†
- **HttpOnly Cookies**: é˜²æ­¢ XSS æ”»å‡»
- **Secure Cookies**: ç”Ÿäº§ç¯å¢ƒå¯ç”¨ HTTPS
- **SameSite**: é˜²æ­¢ CSRF æ”»å‡»
- **è‡ªåŠ¨è¿‡æœŸ**: 24å°æ—¶ä¼šè¯è¶…æ—¶

### 2. æƒé™éªŒè¯
- **ç»Ÿä¸€éªŒè¯**: æ‰€æœ‰ API ä½¿ç”¨ç›¸åŒçš„éªŒè¯é€»è¾‘
- **è‡ªåŠ¨é‡å®šå‘**: é¡µé¢çº§è®¤è¯å¤±è´¥è‡ªåŠ¨è·³è½¬
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯ä¿¡æ¯å’ŒçŠ¶æ€ç 

### 3. ç¯å¢ƒé…ç½®
- **ç¯å¢ƒå˜é‡**: å‡­æ®å­˜å‚¨åœ¨ `.env` æ–‡ä»¶
- **é…ç½®éªŒè¯**: å¯åŠ¨æ—¶æ£€æŸ¥å¿…è¦é…ç½®
- **å¼€å‘æ¨¡å¼**: å¼€å‘ç¯å¢ƒç‰¹æ®Šå¤„ç†

## ğŸ¨ ä½¿ç”¨å»ºè®®

### 1. API å¼€å‘
```typescript
// æ¨èï¼šä½¿ç”¨ä¾¿æ·å‡½æ•°
const authResult = verifyAdminApiAccess(cookies);
if (!authResult.isAuthorized) {
  return json({ error: authResult.error }, { status: 401 });
}

// æˆ–è€…ï¼šä½¿ç”¨ç±»æ–¹æ³•è·å¾—æ›´å¤šæ§åˆ¶
const session = AdminAuthService.getSession(cookies);
if (!session?.isAuthenticated) {
  return json({ error: 'æœªè®¤è¯' }, { status: 401 });
}
```

### 2. é¡µé¢å¼€å‘
```typescript
// å¼ºåˆ¶è®¤è¯é¡µé¢
const adminSession = requireAdminPage(cookies);

// å¯é€‰è®¤è¯é¡µé¢
const { isAdmin, session } = checkAdminPage(cookies);
```

### 3. é”™è¯¯å¤„ç†
```typescript
try {
  const adminSession = requireAdminAuth(cookies);
  // å¤„ç†å·²è®¤è¯çš„è¯·æ±‚
} catch (error) {
  // å¤„ç†è®¤è¯å¤±è´¥
  return json({ error: 'è®¤è¯å¤±è´¥' }, { status: 401 });
}
```

## ğŸ”„ æ‰©å±•åŠŸèƒ½

### 1. å¤šè§’è‰²æ”¯æŒ
å¯ä»¥æ‰©å±• `AdminSession` æ¥å£æ·»åŠ è§’è‰²å­—æ®µï¼š
```typescript
interface AdminSession {
  isAuthenticated: boolean;
  username?: string;
  role?: 'admin' | 'moderator' | 'editor';
  permissions?: string[];
  expiresAt?: number;
}
```

### 2. å®¡è®¡æ—¥å¿—
å¯ä»¥åœ¨è®¤è¯æœåŠ¡ä¸­æ·»åŠ æ—¥å¿—è®°å½•ï¼š
```typescript
static logAuthEvent(event: string, username?: string) {
  console.log(`[AUTH] ${event} - ${username || 'anonymous'} - ${new Date().toISOString()}`);
}
```

### 3. é€Ÿç‡é™åˆ¶
å¯ä»¥æ·»åŠ ç™»å½•å°è¯•é™åˆ¶ï¼š
```typescript
static checkRateLimit(ip: string): boolean {
  // å®ç° IP åŸºç¡€çš„é€Ÿç‡é™åˆ¶
  return true;
}
```

è¿™ä¸ªè®¤è¯æœåŠ¡ç°åœ¨æä¾›äº†å®Œæ•´çš„ã€å¯å¤ç”¨çš„ç®¡ç†å‘˜è®¤è¯åŠŸèƒ½ï¼Œå¯ä»¥åœ¨æ•´ä¸ªåº”ç”¨ä¸­å®‰å…¨åœ°ä½¿ç”¨ã€‚
